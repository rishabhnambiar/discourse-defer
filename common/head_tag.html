<script type="text/x-handlebars" data-template-name="/connectors/topic-footer-main-buttons-before-create/defer">
{{d-button
  class="btn defer-topic"
  icon="circle"
  label="defer_button.defer.title"
  action="deferTopic"}}
</script>

<script type="text/discourse-plugin" version="0.1">

const ajax = require("discourse/lib/ajax").ajax;
const popupAjaxError = require("discourse/lib/ajax-error").popupAjaxError;
const DiscourseURL = require("discourse/lib/url").default;
const container = api.container;

I18n.translations.en = I18n.translations.en || {};
I18n.translations.en.js = I18n.translations.en.js || {};
I18n.translations.en.js.defer_button = {defer: { title: 'Defer' }};

function allowUser(user) {
  if (!user) {
    return false;
  }
  const username = user.get('username').toLowerCase();
  return username === 'sam' || username === 'hawk';
}

function deferTopic(topic) {
  const screenTrack = container.lookup("screen-track:main");
  const currentUser = container.lookup("current-user:main");
  screenTrack.reset();
  screenTrack.stop();
  const goToPath = topic.get('isPrivateMessage') ? currentUser.pmPath(topic) : '/';
  ajax("/t/" + topic.get('id') + "/timings.json?last=1", {type: "DELETE"})
  .then(() => {
      const highestSeenByTopic = Discourse.Session.currentProp("highestSeenByTopic");
      highestSeenByTopic[topic.get('id')] = null;
      DiscourseURL.routeTo(goToPath);
   }).catch(popupAjaxError);
}


api
  .modifySelectKit("topic-footer-mobile-dropdown")
  .modifyContent((context, existingContent) => {
    if (context.get("currentUser.staff")) {
      existingContent.push({
        id: "defer",
        icon: "circle",
        name: I18n.t("defer_button.defer.title")
      });
    }
    return existingContent;
  })
  .onSelect((context, value) => {
    if (value === "defer") {
      const topic = context.get("topic");
      deferTopic(topic);
    }
  });

api.registerConnectorClass(
  "topic-footer-main-buttons-before-create",
  "defer", {
      setupComponent(args) {
          this.set("topic", args.topic);
      },
      shouldRender: function(args, component){
        const currentUser = container.lookup("current-user:main");
        if (!currentUser) {
          return false;
        }

        if (component.get('site.mobileView')) {
          return false;
        }

        return allowUser(currentUser);
      },
      actions: {
          deferTopic(){
            deferTopic(this.get('topic'));
          }
      }
  }
);
</script>

